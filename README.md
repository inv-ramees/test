# 受入テスト期間のリリース運用

## タイムスケジュール

### 前日作業

|時刻|作業内容|
|:---|:---|
| 16:00 | [リリース判断](#anchor1-1) |
| 16:00 ～ 18:00 | [リリースブランチの作成](#anchor1-2)<br />[DB構成変更SQL作成](#anchor1-3)<br />[Azure検証環境デプロイ](#anchor1-4) |
| 18:00 | [Azure検証環境 動作確認](#anchor1-5) |

### 当日作業

|時刻|作業内容|
|:---|:---|
| 09:30 ～ 10:00 | [リリース作業](#anchor2-1) |
| 10:00 ～ | [リリースデータのGitHub管理](#anchor2-2) |

## 作業内容

### <a name="anchor1-1">リリース判断</a>

リリース要否と対象をLINEにて確認する。

- デプロイ対象（Webアプリケーション、バッチ）の確認
- DB構成変更の確認
- 対象がない場合、翌日のリリースはスキップ

### <a name="anchor1-2">リリースブランチの作成</a>

リリースが決定した場合、決定時点のコードでリリースブランチを作成する。

1. ローカルPCにて任意の場所で右クリックし、「TortoiseSVN」⇒「Repo-browser」を押下
1. URLに下記を指定して「OK」を押下
    - `https://r.svn.ne.jp/cmic/svn/NewSMOMO/branches/Release`
1. 「Repository Browser」ウィンドウの右枠を右クリックして「Create folder」を押下
    1. 「New name」にて「yyyymmdd(リリース日)_[SMOMO|SMONEY|SMART|API]」を指定して「OK」を押下  
        - すでに作成済みの場合、末尾に「.n」で1始まりの連番を振る
        - 複数同時にリリースする場合、"-"で繋ぐ
    1. 「Entry Log Message」にて下記を指定して「OK」を押下
        - yyyy-mm-dd リリースブランチ作成
1. 「Repository Browser」ウィンドウの上部URLに下記を指定して移動
    - `https://r.svn.ne.jp/cmic/svn/NewSMOMO/trunk`
1. 右枠よりリリース対象となるフォルダを右クリックし、「Copy to」を押下
    - Webアプリケーション ⇒ 「SMFApp」フォルダ
1. 「Copy to」ウィンドウのURLに下記を指定
    - `https://r.svn.ne.jp/cmic/svn/NewSMOMO/branches/Release/{リリースフォルダ}`
1. 「OK」ボタンを押下してブランチを作成

### <a name="anchor1-3">DB構成変更SQL作成</a>

DB構成変更の有無を確認し、変更の必要がある場合はDB構成変更スクリプト作成を作成する。

#### 初期投入データの洗い替え

初期投入データの投入を行う場合、差分追加ではなく該当テーブルの洗い替えを実施する。

- 対象が複数ある場合、下記のDML抽出ツールを用いる
```
\Box\SMOMOリニューアルPJ\90_Work\23_野口\簡易作業ツール
初期投入データDMLファイル自動生成.xlsm
```
※ 使用方法は該当ファイルを参照

#### テーブル追加・削除・変更

テーブル構成の変更がある場合、テーブルの作成・削除、および現テーブルからのデータの移行を行う。

- 対象が複数ある場合、下記の差分抽出ツールからも移行スクリプトの生成が可能
- カラム追加の場合、`ALTER TABLE ADD COLUMN`はカラムが定義書と異なる配置になるため厳禁

```
\Box\SMOMOリニューアルPJ\90_Work\23_野口\簡易作業ツール
DDL差分出力.xlsm
```
※ 使用方法は該当ファイルを参照

#### SQLファイルの管理

作成したSQLファイルは下記にリリースフォルダを作成して、その中に格納する。

```
\Box\SMOMOリニューアルPJ\50_システム開発\200.基本設計\400.移行設計\407.移行作業
```

### <a name="anchor1-4">Azure検証環境デプロイ</a>

Azure検証環境にデプロイして動作確認を行う。

- 遅くとも18時迄にはデプロイ完了

```
\Box\SMOMOリニューアルPJ\50_システム開発\200.基本設計\100.テーマ別検討資料\250.アーキ・インフラ\005.運用
02_デプロイ作業手順.pdf
```

### <a name="anchor1-5">Azure検証環境 動作確認</a>

Azure検証環境にて動作確認を行い、不具合がないか確認する。

- 不具合の修正があればtrunkへコミットして、リリースブランチを切り直し
    - リリースブランチへのコミットは管理が煩雑になるため、新たに切り直す（枝番を付与）
- 切り直したリリースブランチより再度デプロイを実施する

## 当日作業

### <a name="anchor2-1">リリース作業</a>

受入テスト環境・データ作成環境へのリリースを行う。

- DB構成変更スクリプトの処理時間によっては開始時間を前倒し

```
\Box\SMOMOリニューアルPJ\50_システム開発\200.基本設計\100.テーマ別検討資料\250.アーキ・インフラ\005.運用
02_デプロイ作業手順.pdf
```

### <a name="anchor2-2">リリースデータのGitHub管理</a>

- 運用切り替えを見越してリリース対象をgitにpush

| 対象 | Repository |
|:---:|:---:|
| ソースコード | [CHI-SMOMO/smomo-family](https://github.com/CHI-SMOMO/smomo-family) |
| SQL | [CHI-SMOMO/sql](https://github.com/CHI-SMOMO/sql) |

```
\Box\SMOMOリニューアルPJ\50_システム開発\200.基本設計\100.テーマ別検討資料\250.アーキ・インフラ\005.運用
03_GitHub管理手順.pdf
```
