# 前置き

当作業手順は手作業によるデプロイを行う際の手順となる。  

# 事前準備

- 作業者のPCにVisualStudioをインストール
- リリースブランチの作成
- ログインID/パスの確認
```
Box\SMOMOリニューアルPJ\80_HW_ソフトウェア\アカウント_ライセンス情報
開発アカウント情報.xlsx
```

# デプロイ手順

1. [コードの取得](#anchor1)
1. [ビルド](#anchor2)
1. [Config設定](#anchor3)
1. [アプリケーションの停止](#anchor4)
1. [デプロイ](#anchor5)
1. [アプリケーションの再開](#anchor6)
1. [動作確認](#anchor7)

## <a id="anchor1">1. SVNから取得</a>

リリース対象のソースコードを取得する。

### 作業手順

1. ローカルPC上の任意の場所にリリース用フォルダを作成
1. リリース用フォルダを右クリックし、「SVN Checkout」を押下
1. 「Checkout」ウィザードより、下記を指定
    - Repository - URL of repository ⇒ SVN上のリリースブランチ
    - Checkout directory ⇒ 手順1.で作成したフォルダ
    - Revision ⇒ HEAD revision
1. 「OK」を押下してリリース対象のソースコードを取得する

<div style="page-break-before:always"></div>

## <a id="anchor2">2. ビルド</a>

ソースコード取得後、既存のリソースをクリーンして再ビルドを行う。

### 作業手順

| デプロイ対象 | ソリューション |
|:---|:---|
| SMOMO | SMF_99_SMOMO_Web.sln |
| SMONEY | SMF_99_SMOMO_Web.sln |
| SMART | SMF_99_SMOMO_Web.sln |
| API | SMF_10_AppApi.sln |
| SMOMOバッチ | SMF_01_Batch.sln |
| SMONEYバッチ | SMF_01_BatchSmoney.sln |
| SMARTバッチ | SMF_01_BatchSmart.sln |

1. VisualStudioにて上記の表を参照してデプロイ対象のソリューションを選択
1. VisualStudioの上部メニューより「ビルド」⇒「ソリューションのクリーン」を押下
1. クリーン完了後、VisualStudioの上部メニューより「ビルド」⇒「ソリューションのビルド」を押下

<div style="page-break-before:always"></div>

## <a id="anchor3">3. Config設定</a>

| システム | 環境 | 対象Configサンプル |
|:---|:---|:---|
| SMOMO | Azure検証環境| 010_SMOMO_Azure検証_Web.config |
|^| 受入テスト環境| 020_SMOMO_受入テスト_Web.config |
|^|^(業務支援)| 021_SMOMO_受入テスト(業務支援)_Web.config | 
|^| 等価環境| 022_SMOMO_等価環境_Web.config | 
|^| 本番環境| 040_SMOMO_本番_Web.config |
| SMONEY | Azure検証環境| 110_SMONEY_Azure検証_Web.config |
|^| 受入テスト環境| 120_SMONEY_受入テスト_Web.config |
|^| 等価環境| 122_SMONEY_等価環境_Web.config | 
|^| 本番環境| 140_SMONEY_本番_Web.config |
| SMART | Azure検証環境| 210_SMART_Azure検証_Web.config |
|^| 受入テスト環境| 220_SMART_受入テスト_Web.config |
|^| 等価環境| 222_SMONEY_等価環境_Web.config | 
|^| 本番環境| 240_SMART_受入テスト_Web.config |
| API | Azure検証環境| 310_API_Azure検証_Web.config |
|^| 受入テスト環境| 320_API_本番_Web.config |
| SMOMOバッチ | Azure検証環境| 410_SMOMO-BATCH_Azure検証_Web.config |
|^| 受入テスト環境| 420_SMOMO-BATCH_受入テスト_Web.config |
|^| 本番環境| 440_SMOMO-BATCH_本番_Web.config |

Web.configファイルの環境ごとに異なる設定を書き換える。  

**<font color="red">※ データベース接続先はIISProfileにて定義済みのため対応不要</font>**

各環境のサンプルとなるconfigファイルを下記に格納する。  
コード管理されていないため、追加されたconfig値などには未対応のため、適宜SVN上のコードと差分を確認すること。
```
Box\SMOMOリニューアルPJ\50_システム開発\200.基本設計\210.アーキテクト・インフラ\004.デプロイ関連ファイル
```

*■ 環境ごとに異なるConfigパラメータ*

|パラメータ|備考|
|:---|:---|
| sessionState | `mode="Custom"` が適用されている |
| param name="File" | `C:\logs` 配下にログ出力 |
| key="RunMode" | 実行環境が指定されている |
| key="RunSystem" | 実行システムが指定されている |
| key="GrantControlModeFlg" | "1"が指定されている |
| key="BoxClientId" <br/> ～ "BoxSubProjectTemplateFolderId"| 本番環境のみ変更 |
| key="BoxClientUploadFolderId" <br/> ～ "BoxProjectUserFolderId"| 受入テスト環境以降は変更 |
| key="PatientEncryptPassword", <br/>"FacBillAccountEncryptPassword"| 受入テスト環境以降は変更 |

<div style="page-break-before:always"></div>

## <a id="anchor4">4. アプリケーションの停止 (省略可)</a>

|プロジェクト| 公開先 | 接続先URL | リモート接続先|
|:---|:---|:---|:---|
|SMOMO| Azure検証環境<br />等価環境 | http://10.105.167.244/smomo | 10.105.167.246 <br /> 10.105.167.247(停止中) | 
|^| 受入テスト環境 | http://10.105.165.6/smomo | 10.105.165.6 | 
|^| ^ (業務支援) | http://10.105.165.6/smomo-test | 10.105.165.6 | 
|^| 本番環境 | https://smomofamily.cmic.co.jp/smomo| 10.105.167.229 <br /> 10.105.167.230 <br /> 10.105.167.232 | 
|SMONEY| Azure検証環境<br />等価環境 | http://10.105.167.244/smoney | 10.105.167.246 <br /> 10.105.167.247(停止中) | 
|^| 受入テスト環境 | http://10.105.165.6/smoney | 10.105.165.6 | 
|^| 本番環境 | https://smomofamily.cmic.co.jp/smoney| 10.105.167.229 <br /> 10.105.167.230 <br /> 10.105.167.232 | 
|SMART| Azure検証環境<br />等価環境 | http://10.105.167.244/smart | 10.105.167.246 <br /> 10.105.167.247(停止中) | 
|^| 受入テスト環境 | http://10.105.165.6/smart | 10.105.165.6 | 
|^| 本番環境 | https://smomofamily.cmic.co.jp/smart | 10.105.167.229 <br /> 10.105.167.230 <br /> 10.105.167.232 | 
|SMOMOバッチ| Azure検証環境 | http://sv06002/smomo-batch | SV06002 |
|^| 受入テスト環境 | http://sv06004/smomo-batch | SV06004 |
|^| 本番環境 | http://sv06006/smomo-batch | SV06006 |
|SMONEYバッチ| Azure検証環境 | http://sv06002/smoney-batch | SV06002 |
|^| 受入テスト環境 | http://sv06004/smoney-batch | SV06004 |
|^| 本番環境 | http://sv06006/smoney-batch | SV06006 |
|SMARTバッチ| Azure検証環境 | http://sv06002/smart-batch | SV06002 |
|^| 受入テスト環境 | http://sv06004/smart-batch | SV06004 |
|^| 本番環境 | http://sv06006/smart-batch | SV06006 |

デプロイ作業中にアプリケーション利用者がいる場合、エラーとなるケースがあるため、デプロイ前にアプリケーションの停止を行う。

1. デプロイ対象の仮想マシンにリモート接続
    - リモート接続先、およびログインアカウントは下記の表を参照
1. 仮想マシンにて「Windows」ボタン⇒「Windows 管理ツール」⇒「インターネット インフォメーション サービス(IIS)」を起動
1. 「IISマネージャー」の左枠より「サイト」⇒「Default Web Site」を押下
1. 「IISマネージャー」の右枠より「Webサイトの管理」にて「停止」を押下

※ アカウント管理ファイル

```
\Box\SMOMOリニューアルPJ\80_HW_ソフトウェア\アカウント_ライセンス情報
開発アカウント情報.xlsx
```

- リモート接続時のアカウント名は備考欄を参照すること

<div style="page-break-before:always"></div>

## <a id="anchor5">5. デプロイ</a>

VisualStudioにてデプロイを行う。

### 作業手順

| システム | プロジェクト | 環境 | 対象IISProfile |
|:---|:---|:---|:---|
| SMOMO | SMF_01_Web | Azure検証環境| 010_SMOMO_Azure検証-IISProfile |
|^|^| 受入テスト環境| 020_SMOMO_受入テスト-IISProfile |
|^|^|^ (業務支援)| 021_SMOMO_受入テスト(業務支援)-IISProfile | 
|^|^| 等価環境| 022_SMOMO_等価環境-IISProfile |
|^|^| 本番環境| 040_SMOMO_本番-IISProfile |
| SMONEY | SMF_01_Web | Azure検証環境| 110_SMONEY_Azure検証-IISProfile |
|^|^| 受入テスト環境| 120_SMONEY_受入テスト-IISProfile |
|^|^| 等価環境| 122_SMONEY_等価環境-IISProfile |
|^|^| 本番環境| 140_SMONEY_本番-IISProfile |
| SMART | SMF_01_Web | Azure検証環境| 210_SMART_Azure検証-IISProfile |
|^|^| 受入テスト環境| 220_SMART_受入テスト-IISProfile |
|^|^| 等価環境| 222_SMART_等価環境-IISProfile |
|^|^| 本番環境| 240_SMART_本番-IISProfile |
| API | SMF_10_AppApi | Azure検証環境| 310_API_Azure検証-IISProfile |
|^|^| 受入テスト環境| 320_API_受入テスト-IISProfile |
| SMOMOバッチ | SMF_01_Batch | Azure検証環境| 410_SMOMO-BATCH_Azure検証-IISProfile |
|^|^| 受入テスト環境| 420_SMOMO-BATCH_受入テスト-IISProfile |
|^|^| 本番環境| 440_SMOMO-BATCH_本番-IISProfile |
| SMONEYバッチ | SMF_01_BatchSmoney | Azure検証環境| 410_SMONEY-BATCH_Azure検証-IISProfile |
|^|^| 本番環境| 540_SMONEY-BATCH_本番-IISProfile |
| SMARTバッチ | SMF_01_BatchSmart | Azure検証環境| 410_SMART-BATCH_Azure検証-IISProfile |
|^|^| 本番環境| 640_SMART-BATCH_本番-IISProfile |

1. VisualStudioのソリューションエクスプローラーにてデプロイするプロジェクトを右クリック⇒「発行」を押下
1. 公開ウィンドウにてデプロイ先の環境によりIISProfileを選択(下記の表を参照)
1. 公開ウィンドウにて「発行」ボタンを押下
    - パスワードを求められた際にはアカウント管理ファイルを参照
1. 出力されるコンソールより発行が正常に終了したことを確認する

*■ Azure検証などのVM ScaleSetを利用している環境*

VM ScaleSetを利用している場合、複数のVMが起動しているため全てのVMに対してデプロイを行う。

|プロジェクト| 公開先 | デプロイ先 |
|:---|:---|:---|
|SMOMO| Azure検証環境 | 10.105.167.246 <br /> 10.105.167.247(停止中)  | 
|^| 本番環境 | 10.105.167.229 <br /> 10.105.167.230 <br /> 10.105.167.230 | 
|SMONEY| Azure検証環境 | 10.105.167.246 <br /> 10.105.167.247(停止中)  | 
|^| 本番環境 | 10.105.167.229 <br /> 10.105.167.230 <br /> 10.105.167.230 | 
|SMART| Azure検証環境 | 10.105.167.246 <br /> 10.105.167.247(停止中)  | 
|^| 本番環境 | 10.105.167.229 <br /> 10.105.167.230 <br /> 10.105.167.230 | 

<div style="page-break-before:always"></div>

## <a id="anchor6">6. アプリケーションの再開</a>

デプロイ前に停止させたアプリケーションを再開させる。

1. デプロイ対象の仮想マシンにリモート接続
1. 仮想マシンにて「Windows」ボタン⇒「Windows 管理ツール」⇒「インターネット インフォメーション サービス(IIS)」を起動
1. 「IISマネージャー」の左枠より「サイト」⇒「Default Web Site」を押下
1. 「IISマネージャー」の右枠より「Webサイトの管理」にて「開始」を押下

<div style="page-break-before:always"></div>

## <a id="anchor7">7. 動作確認</a>

各環境のURLから更新内容を確認する。

---

以上
